---
layout: blog
book: true
title:  "Windows驱动开发(第二天)"
background: purple
background-image: http://ot1cc1u9t.bkt.clouddn.com/17-7-15/43335546.jpg
date:   2018-09-18 8:53:43
category: 安全
tags:
- 驱动开发 
---

### 0x01 驱动对象
驱动对象,代表着你编写的这个驱动程序，从面向对象的角度看就如同Windows编程时的实例句柄INSTANCE代表一个应用程序一样
	
当驱动一加载，对象管理器便会生成一个驱动对象,并且调用```DriverEntry```，将驱动对象传入，我们可以在```DriverEntry```中为驱动对象的各个字段赋值，为整体的驱动程序定下总基调。

例如:设定卸载驱动的函数，设定处理各个消息的处理函数

```c
typedef struct _DRIVER_OBJECT {
    CSHORT Type;//类型
    CSHORT Size;//大小
    PDEVICE_OBJECT DeviceObject;//设备链 设备对象
    ULONG Flags;
    PVOID DriverStart;//这个内核模块在内核空间中的开始地址
    ULONG DriverSize;//这个内核模块在内核空间中的大小
    PVOID DriverSection;
    PDRIVER_EXTENSION DriverExtension;//驱动扩展，对于WDM程序比较重要
    UNICODE_STRING DriverName;//驱动的名称
    PUNICODE_STRING HardwareDatabase;//设备的硬件数据库名称
    PFAST_IO_DISPATCH FastIoDispatch;//文件驱动程序中的快速IO请求函数地址
    PDRIVER_INITIALIZE DriverInit;
    PDRIVER_STARTIO DriverStartIo;//DriverStartIo派发函数的地址
    PDRIVER_UNLOAD DriverUnload;//卸载函数指针
    PDRIVER_DISPATCH MajorFunction[IRP_MJ_MAXIMUM_FUNCTION + 1];//普通分发函数
} DRIVER_OBJECT;
```
重要的字段:

		DrivceObject(设备对象):每个驱动程序都会有一个或多个设备对象，所有设备对象以链表的形式串联起来，驱动对象中的设备对象字段指的是所有设备对象的第一个对象，通过它可以遍历所有的设备对象
		DriverName(驱动名称):该驱动的名称，采用UNICODE编码该字符串的一般形式为\Driver\[驱动程序名称]
		DriverUnload(驱动卸载):指向该驱动程序的卸载函数地址。
		MajorFunction(派遣函数指针数组):该数组的每个指针成员指向一个响应的处理IRP的派遣函数
		
		

### 0x02 例子:遍历所有驱动


```c++
#include <ntddk.h>
typedef struct _LDR_DATA_TABLE_ENTRY
{
	LIST_ENTRY InLoadOrderLinks;
	LIST_ENTRY InMemoryOrderLinks;
	LIST_ENTRY InInitializationOrderLinks;
	PVOID DllBase;
	PVOID EntryPoint;
	ULONG SizeOfImage;
	UNICODE_STRING FullDllName;
	UNICODE_STRING BaseDllName;
	ULONG Flags;
	USHORT LoadCount;
	USHORT TlsIndex;
	union
	{
		LIST_ENTRY HashLinks;
		struct
		{
			PVOID SectionPointer;
			ULONG CheckSum;
		};
	};
	union
	{
		struct 
		{
			ULONG TimeDateStamp;
		};
		struct  
		{
			PVOID LoadedImports;
		};
	};
} LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;

void EnumDriver(PDRIVER_OBJECT pDriver)
{
	PLDR_DATA_TABLE_ENTRY pLdr = (PLDR_DATA_TABLE_ENTRY)pDriver->DriverSection;
	LIST_ENTRY *pTemp = &pLdr->InLoadOrderLinks;
	do
	{
		PLDR_DATA_TABLE_ENTRY pDriverInfo = (PLDR_DATA_TABLE_ENTRY)pTemp;
		KdPrint(("%wZ\n", &pDriverInfo->FullDllName));
		pTemp = pTemp->Blink;
	} while (pTemp != &pLdr->InLoadOrderLinks);
}

VOID DriverUnload(PDRIVER_OBJECT drive)
{
	DbgPrint("卸载驱动!");
}

NTSTATUS DriverEntry(PDRIVER_OBJECT drive, PUNICODE_STRING path)
{
	drive->DriverUnload = DriverUnload;
	EnumDriver(drive);
	return STATUS_SUCCESS;
}
```


![EnumDriver](https://raw.githubusercontent.com/catsay217994/catsay217994.github.io/master/_posts/security_image/EnumDriver.png "EnumDriver]")

### 0x03 设备对象

在内核程序中，负责与外部进行交流的是设备对象，就如同Windows应用程序中的窗口。在内核编程中，大部分的消息都是以IRP的方式传递，能够接收IRP的只有设备对象。

一个驱动程序可以有多个设备对象，创建设备对象的时候需要指明其所属的驱动对象是谁

```c++
typedef struct DECLSPEC_ALIGN(MEMORY_ALLOCATION_ALIGNMENT) _DEVICE_OBJECT {
    CSHORT Type;
    USHORT Size;
    LONG ReferenceCount;
    struct _DRIVER_OBJECT *DriverObject;
    struct _DEVICE_OBJECT *NextDevice;
    struct _DEVICE_OBJECT *AttachedDevice;
    struct _IRP *CurrentIrp;
    PIO_TIMER Timer;
    ULONG Flags;                                // See above:  DO_...
    ULONG Characteristics;                      // See ntioapi:  FILE_...
    __volatile PVPB Vpb;
    PVOID DeviceExtension;
    DEVICE_TYPE DeviceType;
    CCHAR StackSize;
    union {
        LIST_ENTRY ListEntry;
        WAIT_CONTEXT_BLOCK Wcb;
    } Queue;
    ULONG AlignmentRequirement;
    KDEVICE_QUEUE DeviceQueue;
    KDPC Dpc;
    ULONG ActiveThreadCount;
    PSECURITY_DESCRIPTOR SecurityDescriptor;
    KEVENT DeviceLock;
    USHORT SectorSize;
    USHORT Spare1;
    struct _DEVOBJ_EXTENSION  *DeviceObjectExtension;
    PVOID  Reserved;
} DEVICE_OBJECT;
```

重要字段:

		DriverObject:指出设备对象归属哪个驱动程序(驱动对象)
		NextDevice:下一个设备对象(一个驱动程序可以创建多个设备对象)，这个设备对象是同一层的
		AttachedDevice:指向下一层驱动程序的设备对象(可以理解被挂载的设备对象)
		CurrentIrp:使用IRP串行化时很重要，用来决策IRP完成还是挂起等
		StackSize:设备栈的个数
		DeviceExtension:指向LDR链的指针

设备对象中只包含了设备的基本信息，如果需要保存其他的信息可以使用设备扩展。
通常我们将全局变量以设备扩展的方式存储，加以适当的同步保护，可以增强程序健壮性。