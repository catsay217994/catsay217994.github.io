---
layout: blog
book: true
title:  "Windows驱动开发(第一天)"
background: purple
background-image: http://ot1cc1u9t.bkt.clouddn.com/17-7-15/43335546.jpg
date:   2018-09-17 7:13:52
category: 安全
tags:
- 驱动开发 
---
# 0x00.准备工作
我使用的是Visual Studio 2013 + WDK8.1,在文章中我就不多说安装配置了(自行Google)


# 0x01.数据类型

一般来说，在进行内核编程的时候，应该遵守WDK的规则，虽然不是必须的。
举个栗子~
```c
unsigned long length;//定义一个无符号长整型的数据
```
看起来似乎是没有什么毛病,但是有时候确实是有问题的。因为不同的C语言编译器或者为不同的目标平台编译,有可能unsigned long表示的实际字节长度不一样。
假设在32位环境下认为unsigned long是4个字节，而64位环境下认为unsigned long是8个字节(但是x64环境下unsigned long依然是4个字节,这里只是为了举个栗子)

因此，WDK规范中不直接使用unsigned long，而是使用已经重新定义过的ULONG。

- unsigned long重定义为ULONG
- unsigned char重定义为UCHAR
- unsigned int重定义为UINT
- void重定义为VOID
- unsigned long*重定义为PULONG
- unsigned char*重定义为PUCHAR
- unsigned int*重定义为PUINT
- void*重定义为PVOID

# 0x02.返回状态

绝大部分的内核API的返回值是一个返回状态,也就是一个错误码。这个类型为NTSTATUS。我们自己写函数大部分也这么做
例如:
```c
NTSTATUS MyFunction()
{
	NTSTATUS status;
	//打开一个文件
	status = ZwCreateFile(...);
	if(!NT_SUCCESS(status))
	{
		//如果出错了就直接返回错误
		return status;
	}
	...
}
```
这个例子可以看出,使用宏NT_SUCCESS()可以判断一个返回值是否成功。
在写函数的时候，检测到了错误，编写者可以返回任何一个错误码
![ERROR_CODE](https://raw.githubusercontent.com/catsay217994/catsay217994.github.io/master/_posts/security_image/Driver_Return_Code.jpg "ERROR_CODE")

# 0x03.字符串
驱动里字符串一般都用结构体存放，结构体定义:
```c
typedef struct _UNICODE_STRING {
    USHORT Length;
    USHORT MaximumLength;
	PWSTR  Buffer;
} UNICODE_STRING *PUNICODE_STRING;
```
这个是宽字符，是双字节的。在很多情况下不直接使用字符的指针，而是将这个结构作为字符串使用，结构的指针可以直接在DbgPrint中打印
打印指针可以用%wZ来打印

UNICODE_STRING除了可以初始化和打印之外，还可以像普通字符串一样做很多操作，比如拷贝，连接，转换等等

```c
#include <ntddk.h>

VOID DriverUnload(PDRIVER_OBJECT driver)
{
	UNICODE_STRING str = RTL_CONSTANT_STRING(L"驱动卸载!");
	DbgPrint("%wZ", &str);
}

NTSTATUS DriverEntry(PDRIVER_OBJECT driver, PUNICODE_STRING Reg_Path)
{
	UNICODE_STRING str = RTL_CONSTANT_STRING(L"驱动入口!");
	DbgPrint("%wZ", &str);
	driver->DriverUnload = DriverUnload;
	return STATUS_SUCCESS;
}
```
![Driver1](https://raw.githubusercontent.com/catsay217994/catsay217994.github.io/master/_posts/security_image/Driver1.PNG "Driver1")
